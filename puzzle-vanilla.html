<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>This Puzzle</title>
  <style>
    body {
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      max-width: 1200px;
      margin: 0;
      padding: 20px;
      background: #0d1117;
      color: #c9d1d9;
      font-size: 14px;
      line-height: 1.5;
    }
    h1 {
      font-size: 18px;
      font-weight: normal;
      margin-bottom: 20px;
      color: #8b949e;
    }
    .goal {
      background: transparent;
      padding: 0;
      margin-bottom: 20px;
      border: none;
      font-size: 14px;
      color: #58a6ff;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 30px;
      margin-bottom: 20px;
    }
    .panel {
      border: none;
      min-height: 300px;
      padding: 0;
      background: transparent;
    }
    .panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #8b949e;
      font-size: 12px;
      font-weight: normal;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .code-line {
      background: transparent;
      padding: 4px 8px;
      margin: 2px 0;
      cursor: pointer;
      border: none;
      border-left: 2px solid transparent;
      transition: all 0.1s;
      font-family: inherit;
      color: #c9d1d9;
    }
    .code-line:hover {
      background: #161b22;
      border-left-color: #58a6ff;
    }
    .code-line:before {
      content: '';
      display: inline-block;
      width: 12px;
    }
    .selected-line {
      background: transparent;
      border: none;
      border-left: 2px solid #58a6ff;
      padding: 4px 8px;
      margin: 2px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #c9d1d9;
    }
    .selected-line .line-content {
      display: flex;
      align-items: center;
      flex: 1;
    }
    .selected-line .line-number {
      color: #484f58;
      width: 20px;
      text-align: right;
      margin-right: 12px;
      user-select: none;
      font-size: 12px;
    }
    .controls button {
      background: transparent;
      color: #8b949e;
      border: none;
      padding: 2px 6px;
      margin-left: 8px;
      cursor: pointer;
      font-family: monospace;
      font-size: 12px;
    }
    .controls button:hover {
      color: #c9d1d9;
    }
    .controls button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .check-btn {
      background: transparent;
      color: #8b949e;
      border: 1px solid #30363d;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
      margin-right: 10px;
      margin-top: 10px;
    }
    .check-btn:hover {
      border-color: #58a6ff;
      color: #c9d1d9;
    }
    .result {
      margin-top: 15px;
      padding: 10px 0;
      border-radius: 0;
      font-size: 14px;
    }
    .correct {
      background: transparent;
      border: none;
      color: #3fb950;
    }
    .incorrect {
      background: transparent;
      border: none;
      color: #f85149;
    }
    textarea {
      width: 100%;
      min-height: 300px;
      background: #0d1117;
      color: #c9d1d9;
      border: 1px solid #30363d;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
    }
    textarea:focus {
      outline: none;
      border-color: #58a6ff;
    }
    .mode-toggle {
      margin-bottom: 20px;
      font-size: 12px;
    }
    .mode-toggle button {
      background: transparent;
      color: #8b949e;
      border: 1px solid #30363d;
      padding: 4px 12px;
      cursor: pointer;
      font-family: inherit;
      margin-right: 5px;
    }
    .mode-toggle button.active {
      border-color: #58a6ff;
      color: #58a6ff;
    }
  </style>
</head>
<body>
  <h1>// this puzzle</h1>

  <div class="mode-toggle">
    <button id="puzzle-mode" class="active" onclick="setMode('puzzle')">puzzle mode</button>
    <button id="freeplay-mode" onclick="setMode('freeplay')">fuck it we ball</button>
  </div>

  <div id="app"></div>

  <script>
    const PUZZLES = [
      {
        id: 1,
        goal: "this.value === 11",
        description: "// first two-digit prime",
        goalCheck: (ctx) => ctx.value === 11,
        availableLines: [
          "this.value = 5",
          "this.value += 6",
          "this.value += 1",
          "this.value *= 2",
        ],
        initialContext: { value: 0 }
      },
      {
        id: 2,
        goal: "this.value === 13",
        description: "// second two-digit prime",
        goalCheck: (ctx) => ctx.value === 13,
        availableLines: [
          "let x = { value: 10 }",
          "this = x",
          "this.value += 3",
          "this.value = 5",
          "this.value *= 2",
          "this.value += 8"
        ],
        initialContext: { value: 0 }
      },
      {
        id: 3,
        goal: "this.age === 25",
        description: "// quarter century",
        goalCheck: (ctx) => ctx.age === 25,
        availableLines: [
          "this.age = 20",
          "this.age = 10",
          "this.age += 5",
          "this.age *= 2",
          "this.age += 15"
        ],
        initialContext: { age: 0 }
      }
    ];

    let currentPuzzleIndex = 0;
    let selectedLines = [];
    let mode = 'puzzle';

    function setMode(newMode) {
      mode = newMode;
      document.getElementById('puzzle-mode').classList.toggle('active', mode === 'puzzle');
      document.getElementById('freeplay-mode').classList.toggle('active', mode === 'freeplay');
      render();
    }

    function renderPuzzleMode() {
      const puzzle = PUZZLES[currentPuzzleIndex];
      const app = document.getElementById('app');

      app.innerHTML = `
        <div class="goal">
          ${puzzle.description}
          <br>goal: ${puzzle.goal}
        </div>

        <div class="container">
          <div class="panel">
            <h3>available</h3>
            <div id="available"></div>
          </div>

          <div class="panel">
            <h3>your code</h3>
            <div id="selected"></div>
          </div>

          <div class="panel">
            <h3>output</h3>
            <div id="result"></div>
          </div>
        </div>

        <div>
          <button class="check-btn" onclick="checkSolution()">run</button>
          <button class="check-btn" onclick="reset()">reset</button>
          <button class="check-btn" onclick="nextPuzzle()">next puzzle</button>
        </div>
      `;

      // Render available lines
      const availableDiv = document.getElementById('available');
      puzzle.availableLines.forEach((line, i) => {
        const div = document.createElement('div');
        div.className = 'code-line';
        div.textContent = line;
        div.onclick = () => addLine(line);
        availableDiv.appendChild(div);
      });

      // Render selected lines
      const selectedDiv = document.getElementById('selected');
      selectedLines.forEach((line, i) => {
        const div = document.createElement('div');
        div.className = 'selected-line';
        div.innerHTML = `
          <div class="line-content">
            <span class="line-number">${i + 1}</span>
            <span>${line}</span>
          </div>
          <div class="controls">
            <button onclick="moveUp(${i})" ${i === 0 ? 'disabled' : ''}>↑</button>
            <button onclick="moveDown(${i})" ${i === selectedLines.length - 1 ? 'disabled' : ''}>↓</button>
            <button onclick="removeLine(${i})">×</button>
          </div>
        `;
        selectedDiv.appendChild(div);
      });
    }

    function renderFreeplayMode() {
      const puzzle = PUZZLES[currentPuzzleIndex];
      const app = document.getElementById('app');

      const code = selectedLines.length > 0
        ? selectedLines.join(';\n') + ';'
        : '// write whatever you want\n// eval will run it when you hit run\n';

      app.innerHTML = `
        <div class="goal">
          ${puzzle.description}
          <br>goal: ${puzzle.goal}
        </div>

        <div class="container">
          <div class="panel" style="grid-column: 1 / 3;">
            <h3>code</h3>
            <textarea id="freeplay-code">${code}</textarea>
          </div>

          <div class="panel">
            <h3>output</h3>
            <div id="result"></div>
          </div>
        </div>

        <div>
          <button class="check-btn" onclick="runFreeplay()">run</button>
          <button class="check-btn" onclick="nextPuzzle()">next puzzle</button>
        </div>
      `;
    }

    function render() {
      if (mode === 'puzzle') {
        renderPuzzleMode();
      } else {
        renderFreeplayMode();
      }
    }

    function addLine(line) {
      selectedLines.push(line);
      render();
    }

    function removeLine(index) {
      selectedLines.splice(index, 1);
      render();
    }

    function moveUp(index) {
      if (index === 0) return;
      [selectedLines[index - 1], selectedLines[index]] = [selectedLines[index], selectedLines[index - 1]];
      render();
    }

    function moveDown(index) {
      if (index === selectedLines.length - 1) return;
      [selectedLines[index], selectedLines[index + 1]] = [selectedLines[index + 1], selectedLines[index]];
      render();
    }

    function reset() {
      selectedLines = [];
      render();
    }

    function nextPuzzle() {
      currentPuzzleIndex = (currentPuzzleIndex + 1) % PUZZLES.length;
      selectedLines = [];
      render();
    }

    function checkSolution() {
      const puzzle = PUZZLES[currentPuzzleIndex];
      const resultDiv = document.getElementById('result');

      try {
        let thisContext = { ...puzzle.initialContext };

        selectedLines.forEach(line => {
          let execLine = line.replace(/this\./g, 'thisContext.');
          if (line.includes('this =')) {
            execLine = line.replace('this =', 'thisContext =');
          }
          eval(execLine);
        });

        const success = puzzle.goalCheck(thisContext);

        if (success) {
          resultDiv.innerHTML = `<div class="result correct">✓ ${puzzle.goal}</div>`;
        } else {
          resultDiv.innerHTML = `<div class="result incorrect">✗ ${JSON.stringify(thisContext)}</div>`;
        }
      } catch (e) {
        resultDiv.innerHTML = `<div class="result incorrect">error: ${e.message}</div>`;
      }
    }

    function runFreeplay() {
      const puzzle = PUZZLES[currentPuzzleIndex];
      const resultDiv = document.getElementById('result');
      const code = document.getElementById('freeplay-code').value;

      try {
        let thisContext = { ...puzzle.initialContext };

        // Replace this references
        let execCode = code.replace(/this\./g, 'thisContext.');
        execCode = execCode.replace(/this =/g, 'thisContext =');

        // Capture console output
        let output = [];
        const originalLog = console.log;
        console.log = (...args) => output.push(args.join(' '));

        eval(execCode);

        console.log = originalLog;

        const success = puzzle.goalCheck(thisContext);

        let html = '';
        if (output.length > 0) {
          html += `<div style="color: #8b949e; margin-bottom: 10px;">${output.join('\n')}</div>`;
        }

        if (success) {
          html += `<div class="result correct">✓ ${puzzle.goal}</div>`;
        } else {
          html += `<div class="result incorrect">✗ ${JSON.stringify(thisContext)}</div>`;
        }

        resultDiv.innerHTML = html;
      } catch (e) {
        resultDiv.innerHTML = `<div class="result incorrect">error: ${e.message}</div>`;
      }
    }

    render();
  </script>
</body>
</html>
